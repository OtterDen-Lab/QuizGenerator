name: Release on version bump

on:
  push:
    branches:
      - main    # change if your default branch is different
  workflow_dispatch:    # allows manual triggering from GitHub Actions UI

jobs:
  # Run checks before releasing
  checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v6

      - name: Set up Python
        run: uv python install 3.12

      - name: Sync dependencies
        run: uv sync --extra dev

      - name: Install Typst
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"
          ASSET_URL=$(python - <<'PY'
          import json
          import urllib.request

          url = "https://api.github.com/repos/typst/typst/releases/latest"
          data = json.load(urllib.request.urlopen(url))
          asset_url = None
          for asset in data.get("assets", []):
              name = asset.get("name", "").lower()
              if "linux" in name and ("x86_64" in name or "amd64" in name):
                  if name.endswith((".tar.xz", ".tar.gz")):
                      asset_url = asset.get("browser_download_url")
                      break
          if not asset_url:
              raise SystemExit("No suitable Typst asset found.")
          print(asset_url)
          PY
          )
          curl -fsSL -o /tmp/typst.tar $ASSET_URL
          rm -rf /tmp/typst && mkdir -p /tmp/typst
          tar -xf /tmp/typst.tar -C /tmp/typst
          TYPST_BIN=$(find /tmp/typst -type f -name typst | head -n 1)
          if [ -z "$TYPST_BIN" ]; then
            echo "Typst binary not found in archive."
            exit 1
          fi
          cp "$TYPST_BIN" "$HOME/.local/bin/typst"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          typst --version

      - name: Run repository hygiene checks
        run: bash scripts/check_repo_hygiene.sh

      - name: Run tests
        run: uv run pytest -q

      - name: Smoke test (safe sample)
        run: |
          uv run quizgen generate --yaml example_files/example_exam_safe.yaml --num-pdfs 1
          ls out/*.pdf

      - name: Smoke test (FromGenerator sample)
        run: |
          export QUIZGEN_ALLOW_GENERATOR=1
          uv run quizgen generate --allow-generator --yaml example_files/example_exam.yaml --num-pdfs 1
          ls out/*.pdf

  release:
    needs: checks  # Only release if checks pass
    runs-on: ubuntu-latest
    environment:
      name: pypi
    permissions:
      contents: write   # create tags & releases
      id-token: write   # PyPI trusted publishing

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0   # need history to read previous version

      - name: Set up Python for tooling
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get previous version (from parent commit)
        id: prev_version
        run: |
          BEFORE="${{ github.event.before }}"

          # First commit / no parent? treat as "no previous version"
          if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE" ]; then
            echo "No previous commit; setting previous version empty."
            echo "version=" >> "$GITHUB_OUTPUT"
          else
            if git show "$BEFORE":pyproject.toml > pyproject_prev.toml 2>/dev/null; then
              VERSION=$(python -c "import tomllib, pathlib; d = tomllib.loads(pathlib.Path('pyproject_prev.toml').read_text()); print(d['project']['version'])")
              echo "previous version: $VERSION"
              echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            else
              echo "No previous pyproject.toml found; setting previous version empty."
              echo "version=" >> "$GITHUB_OUTPUT"
            fi
          fi

      - name: Get current version
        id: curr_version
        run: |
          VERSION=$(python -c "import tomllib, pathlib; d = tomllib.loads(pathlib.Path('pyproject.toml').read_text()); print(d['project']['version'])")
          echo "current version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Decide whether this is a release commit
        id: decision
        run: |
          PREV="${{ steps.prev_version.outputs.version }}"
          CURR="${{ steps.curr_version.outputs.version }}"
          MSG="${{ github.event.head_commit.message }}"

          echo "Previous version: '$PREV'"
          echo "Current version:  '$CURR'"
          echo "Commit message:   '$MSG'"

          SHOULD_RELEASE=false

          # Release whenever the version changes
          if [ -n "$CURR" ] && [ "$CURR" != "$PREV" ]; then
            echo "Version changed from '$PREV' to '$CURR'; triggering release."
            SHOULD_RELEASE=true
          else
            echo "Version did not change; not releasing."
          fi

          echo "release=$SHOULD_RELEASE" >> "$GITHUB_OUTPUT"

      - name: Stop if not a release
        if: steps.decision.outputs.release != 'true'
        run: |
          echo "Not a release commit; skipping remaining steps."
          exit 0

      - name: Ensure tag does not already exist
        if: steps.decision.outputs.release == 'true'
        run: |
          VERSION="${{ steps.curr_version.outputs.version }}"
          TAG="v${VERSION}"

          echo "Checking for existing tag $TAG"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Aborting."
            exit 1
          fi

      - name: Create and push tag
        if: steps.decision.outputs.release == 'true'
        run: |
          VERSION="${{ steps.curr_version.outputs.version }}"
          TAG="v${VERSION}"

          echo "Creating tag $TAG at $GITHUB_SHA"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag "$TAG" "$GITHUB_SHA"
          git push origin "$TAG"

      - name: Install uv
        if: steps.decision.outputs.release == 'true'
        uses: astral-sh/setup-uv@v6

      - name: Install Python 3.13 for build
        if: steps.decision.outputs.release == 'true'
        run: uv python install 3.13

      - name: Build
        if: steps.decision.outputs.release == 'true'
        run: uv build

      - name: Upload dist artifacts
        if: steps.decision.outputs.release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        if: steps.decision.outputs.release == 'true'
        run: uv publish

      - name: Create GitHub Release
        if: steps.decision.outputs.release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.curr_version.outputs.version }}
          name: v${{ steps.curr_version.outputs.version }}
          body: |
            Release v${{ steps.curr_version.outputs.version }}

            - Version bumped in pyproject.toml
            - Built with uv and published to PyPI.
            - Artifacts attached below.
          files: dist/*
